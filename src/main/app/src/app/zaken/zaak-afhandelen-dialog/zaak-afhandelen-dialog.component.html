<!--
  ~ SPDX-FileCopyrightText: 2022 Atos, 2024 INFO.nl
  ~ SPDX-License-Identifier: EUPL-1.2+
  -->

<mat-toolbar role="heading" class="gap-16" mat-dialog-title>
  <mat-icon>thumb_up_alt</mat-icon>
  <span class="flex-grow-1" *ngIf="data.planItem">
    {{ "planitem." + data.planItem?.userEventListenerActie | translate }}
  </span>
  <span class="flex-grow-1" *ngIf="!data.planItem">
    {{ "actie.zaak.afsluiten" | translate }}
  </span>
  <button mat-icon-button (click)="close()">
    <mat-icon>close</mat-icon>
  </button>
</mat-toolbar>
<mat-divider></mat-divider>

<form [formGroup]="formGroup" (submit)="afhandelen()">
  <mat-dialog-content>
    <p
      *ngIf="data.planItem?.toelichting"
      class="readonly"
      [innerHTML]="data.planItem?.toelichting"
    ></p>
    <p
      *ngIf="
        formGroup.controls.resultaattype.value?.besluitVerplicht &&
        !data.zaak.besluiten?.length
      "
      class="readonly error"
      [innerHTML]="'msg.besluit.verplicht' | translate"
    ></p>
    <zac-static-text
      *ngIf="data.zaak.resultaat"
      label="resultaat"
      [value]="data.zaak.resultaat.resultaattype?.naam"
    />
    <zac-static-text
      *ngFor="let besluit of data.zaak.besluiten"
      [label]="besluit.identificatie | empty"
      [value]="besluit.besluittype?.naam"
    />
    <zac-select
      *ngIf="!data.zaak.resultaat"
      [form]="formGroup"
      key="resultaattype"
      label="resultaat"
      [options]="resultaattypesQuery.data() ?? []"
      optionDisplayValue="naam"
    />
    <zac-input [form]="formGroup" key="toelichting" />
    <zac-date
      [form]="formGroup"
      key="brondatumEigenschap"
      *ngIf="formGroup.controls.resultaattype.value?.datumKenmerkVerplicht"
    >
      <mat-label>{{ "zaak.brondatum" | translate }}</mat-label>
    </zac-date>
    <div
      *ngIf="
        data.zaak.zaaktype.zaakafhandelparameters?.afrondenMail !==
        'NIET_BESCHIKBAAR'
      "
    >
      <mat-checkbox id="sendMail" formControlName="sendMail">
        {{ "sendMail" | translate }}
      </mat-checkbox>
    </div>
    <zac-select
      *ngIf="formGroup.controls.sendMail.value"
      [form]="formGroup"
      key="verzender"
      [options]="afzendersQuery.data() ?? []"
      optionDisplayValue="mail"
      suffix="suffix"
    />
    <zac-input
      *ngIf="formGroup.controls.sendMail.value"
      [form]="formGroup"
      key="ontvanger"
    >
      <button
        *ngIf="initiatorEmailQuery.data()?.emailadres"
        mat-icon-button
        type="button"
        matSuffix
        title="{{ 'actie.initiator.email.toevoegen' | translate }}"
        (click)="setInitiatorEmail()"
      >
        <mat-icon>person</mat-icon>
      </button>
    </zac-input>
    <mat-expansion-panel
      *ngIf="formGroup.controls.sendMail.value"
      class="mat-elevation-z0"
    >
      <mat-expansion-panel-header>
        {{ "body" | translate }}
      </mat-expansion-panel-header>
      <p class="readonly" [innerHTML]="mailtemplateQuery.data()?.body"></p>
    </mat-expansion-panel>
  </mat-dialog-content>
  <mat-dialog-actions>
    <button
      *ngIf="
        !(
          formGroup.controls.resultaattype.value?.besluitVerplicht &&
          !data.zaak.besluiten?.length
        )
      "
      mat-raised-button
      color="primary"
      type="submit"
      [disabled]="loading || formGroup.invalid"
    >
      <mat-icon *ngIf="loading">
        <mat-spinner diameter="18"></mat-spinner>
      </mat-icon>
      {{ "actie.zaak.afhandelen" | translate }}
    </button>
    <button
      *ngIf="
        formGroup.controls.resultaattype.value?.besluitVerplicht &&
        !data.zaak.besluiten?.length
      "
      mat-raised-button
      color="primary"
      (click)="openBesluitVastleggen()"
    >
      {{ "actie.besluit.vastleggen" | translate }}
    </button>
    <button
      mat-raised-button
      [disabled]="loading"
      (click)="close()"
      type="button"
    >
      {{ "actie.annuleren" | translate }}
    </button>
  </mat-dialog-actions>
</form>
