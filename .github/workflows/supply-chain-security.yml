#
# SPDX-FileCopyrightText: 2025 INFO.nl
# SPDX-License-Identifier: EUPL-1.2+
#
name: Supply Chain Security Check

on:
  schedule:
    # Run daily at 6 AM UTC to catch newly discovered vulnerabilities
    - cron: "0 6 * * *"
  push:
    branches: [main]
    paths:
      - '**/package.json'
      - '**/package-lock.json'
      - 'build.gradle.kts'
      - 'gradle/libs.versions.toml'
  workflow_dispatch:

permissions:
  contents: write
  security-events: write
  issues: write
  pull-requests: write
  pages: write

env:
  NODE_VERSION: "22.19.0"
  JAVA_VERSION: "21.0.8"
  SECURITY_SCAN_RETENTION_DAYS: 30  # Maximum age of security scan reports in days

jobs:
  npm-security-audit:
    name: NPM Security Audit
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            src/main/app/package-lock.json
            src/e2e/package-lock.json

      - name: Audit main app dependencies
        working-directory: src/main/app
        run: |
          echo "üîç Running security audit for main application..."
          
          # Generate detailed audit report
          npm audit --json > audit-results.json || true
          
          # Check for high/critical vulnerabilities
          echo "üìä Audit Summary:"
          npm audit --audit-level=info || true
          
          # Fail on high/critical vulnerabilities
          echo "üö® Checking for high/critical vulnerabilities..."
          npm audit --audit-level=high

      - name: Audit e2e test dependencies
        working-directory: src/e2e
        run: |
          echo "üîç Running security audit for e2e tests..."
          
          # Generate detailed audit report
          npm audit --json > audit-results.json || true
          
          # Check for high/critical vulnerabilities
          echo "üìä Audit Summary:"
          npm audit --audit-level=info || true
          
          # Fail on high/critical vulnerabilities
          echo "üö® Checking for high/critical vulnerabilities..."
          npm audit --audit-level=high


  check-compromised-packages:
    name: Check for Compromised Packages
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check for recently compromised packages
        run: |
          echo "üö® Checking for recently compromised npm packages..."
          
          # List of packages from recent supply chain attacks
          COMPROMISED_PACKAGES=(
            "chalk"
            "debug" 
            "ansi-styles"
            "strip-ansi"
            "supports-color"
            "ansi-regex"
            "wrap-ansi"
            "color-convert"
            "slice-ansi"
            "is-arrayish"
            "color-name"
            "error-ex"
            "color-string"
            "simple-swizzle"
            "has-ansi"
            "supports-hyperlinks"
            "chalk-template"
            "backslash"
          )
          
          FOUND_PACKAGES=""
          
          for pkg in "${COMPROMISED_PACKAGES[@]}"; do
            # Check main app
            if [ -f "src/main/app/package-lock.json" ]; then
              if grep -q "\"name\": \"$pkg\"" src/main/app/package-lock.json; then
                echo "‚ö†Ô∏è  Found potentially compromised package '$pkg' in main app"
                FOUND_PACKAGES="$FOUND_PACKAGES\n- $pkg (main app)"
              fi
            fi
            
            # Check e2e tests
            if [ -f "src/e2e/package-lock.json" ]; then
              if grep -q "\"name\": \"$pkg\"" src/e2e/package-lock.json; then
                echo "‚ö†Ô∏è  Found potentially compromised package '$pkg' in e2e tests"
                FOUND_PACKAGES="$FOUND_PACKAGES\n- $pkg (e2e tests)"
              fi
            fi
          done
          
          if [ -n "$FOUND_PACKAGES" ]; then
            echo "üö® WARNING: Found packages that were recently involved in supply chain attacks:"
            echo -e "$FOUND_PACKAGES"
            echo ""
            echo "‚ÑπÔ∏è  These packages may be safe if they're indirect dependencies with versions"
            echo "   that predate the compromise. Manual verification recommended."
            echo ""
            echo "üìã Actions to take:"
            echo "1. Check package versions against known compromise dates"
            echo "2. Run 'npm ls [package-name]' to see why these packages are included" 
            echo "3. Consider updating dependencies to get clean versions"
            echo "4. Monitor for unusual network activity or crypto-related code"
          else
            echo "‚úÖ No recently compromised packages detected"
          fi

  gradle-security-audit:
    name: Gradle Security Audit
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    outputs:
      vuln_total: ${{ steps.owasp_scan.outputs.vuln_total }}
      vuln_critical: ${{ steps.owasp_scan.outputs.vuln_critical }}
      vuln_high: ${{ steps.owasp_scan.outputs.vuln_high }}
      scan_date: ${{ steps.date.outputs.date }}
    env:
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
    steps:
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d-%H-%M')" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup JDK
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@017a9effdb900e5b5b2fddfb590a105619dca3c3 # v4.4.2

      - name: Cache OWASP Dependency Check database
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: ~/.gradle/dependency-check-data
          # Use static key - OWASP database is global and independent of our project
          # Database gets updated weekly via scheduled workflow
          key: owasp-dependency-check-db
          restore-keys: |
            owasp-dependency-check-
            owasp-dependency-check-db-

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@017a9effdb900e5b5b2fddfb590a105619dca3c3 # v4.4.2

      - name: Update OWASP dependency database
        run: |
          echo "üîÑ Updating OWASP Dependency Check database..."
          ./gradlew dependencyCheckUpdate --no-configuration-cache || true
          
          # Show cache info
          if [ -d ~/.gradle/dependency-check-data ]; then
            echo "üìä OWASP database cache status:"
            du -sh ~/.gradle/dependency-check-data
            ls -la ~/.gradle/dependency-check-data/*/odc.mv.db 2>/dev/null | head -3 || true
          fi

      - name: Check for vulnerable Gradle dependencies
        id: owasp_scan
        continue-on-error: true
        run: |
          echo "üîç Running Gradle dependency vulnerability check..."
          
          # Check for known vulnerable dependencies
          echo "üìä Analyzing dependency tree..."
          ./gradlew dependencies --configuration runtimeClasspath > gradle-deps.txt || true
          
          # Run OWASP dependency check (now available)
          echo "üõ°Ô∏è Running OWASP Dependency Check..."
          ./gradlew dependencyCheckAnalyze --no-configuration-cache --info 2>&1 | tee owasp-scan.log || true
          
          # Show SARIF file info if generated
          if [ -f "build/reports/dependency-check-report.sarif" ]; then
            echo "‚úÖ SARIF report generated for GitHub Security upload"
            wc -l build/reports/dependency-check-report.sarif
          else
            echo "‚ùå SARIF report not found"
          fi
          
          # Save vulnerability counts for Slack notification
          if [ -f "build/reports/dependency-check-report.json" ]; then
            TOTAL_VULNS=$(jq '[.dependencies[].vulnerabilities] | flatten | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            CRITICAL_VULNS=$(jq '[.dependencies[].vulnerabilities[] | select(.severity=="CRITICAL")] | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            HIGH_VULNS=$(jq '[.dependencies[].vulnerabilities[] | select(.severity=="HIGH")] | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            echo "vuln_total=$TOTAL_VULNS" >> $GITHUB_OUTPUT
            echo "vuln_critical=$CRITICAL_VULNS" >> $GITHUB_OUTPUT
            echo "vuln_high=$HIGH_VULNS" >> $GITHUB_OUTPUT
          fi
      - name: Generate vulnerability summary
        if: always()
        run: |
          echo "üìä Generating vulnerability summary..."
          
          # Parse OWASP scan results
          TOTAL_VULNS=0
          CRITICAL_VULNS=0
          HIGH_VULNS=0
          MEDIUM_VULNS=0
          LOW_VULNS=0
          
          if [ -f "build/reports/dependency-check-report.json" ]; then
            # Extract vulnerability counts from JSON report
            TOTAL_VULNS=$(jq '[.dependencies[].vulnerabilities] | flatten | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            CRITICAL_VULNS=$(jq '[.dependencies[].vulnerabilities[] | select(.severity=="CRITICAL")] | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            HIGH_VULNS=$(jq '[.dependencies[].vulnerabilities[] | select(.severity=="HIGH")] | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            MEDIUM_VULNS=$(jq '[.dependencies[].vulnerabilities[] | select(.severity=="MEDIUM")] | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            LOW_VULNS=$(jq '[.dependencies[].vulnerabilities[] | select(.severity=="LOW")] | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
          fi
          
          # Write summary to GitHub Step Summary
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## üõ°Ô∏è OWASP Dependency Check Results
          
          **Scan Date:** $(date -u +"%Y-%m-%d %H:%M UTC")
          **Project:** Dimpact Zaakafhandelcomponent
          
          ### Vulnerability Summary
          
          | Severity | Count |
          |----------|-------|
          | üî¥ Critical | $CRITICAL_VULNS |
          | üü† High | $HIGH_VULNS |
          | üü° Medium | $MEDIUM_VULNS |
          | üü¢ Low | $LOW_VULNS |
          | **Total** | **$TOTAL_VULNS** |
          
          ### Reports
          
          - üìÑ [HTML Report](https://infonl.github.io/dimpact-zaakafhandelcomponent/security-scans/${{ steps.date.outputs.date }}/dependency-check-report.html)
          - üìä [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - üîí [Security Tab](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)
          
          ### Actions Taken
          
          - ‚úÖ Scanned all production dependencies
          - ‚úÖ Uploaded SARIF results to GitHub Security
          - ‚úÖ Published detailed HTML report
          - ‚úÖ Cached vulnerability database for future scans
          
          EOF
          
          # Also create a simple text summary file
          cat > build/reports/summary.txt <<EOF
          OWASP Dependency Check Summary
          Scan Date: $(date -u +"%Y-%m-%d %H:%M UTC")
          
          Total Vulnerabilities: $TOTAL_VULNS
          Critical: $CRITICAL_VULNS
          High: $HIGH_VULNS
          Medium: $MEDIUM_VULNS
          Low: $LOW_VULNS
          EOF
          
          cat build/reports/summary.txt

      - name: Check for suspicious dependencies
        run: |
          echo "üö® Checking for suspicious Gradle dependencies..."
          
          # List of potentially suspicious patterns in Java/Kotlin ecosystem
          SUSPICIOUS_PATTERNS=(
            "log4j.*1\\.[0-9]"  # Old Log4j versions (Log4Shell)
            "jackson.*2\\.[0-9]\\.[0-9]$"  # Very old Jackson versions
            "springframework.*[1-4]\\.[0-9]"  # Very old Spring versions
            "commons-collections.*3\\.[0-2]"  # Known deserialization vulnerabilities
            "struts.*2\\.[0-3]"  # Old Struts versions
          )
          
          FOUND_SUSPICIOUS=""
          
          for pattern in "${SUSPICIOUS_PATTERNS[@]}"; do
            if grep -rE "$pattern" build.gradle.kts gradle/ 2>/dev/null; then
              echo "‚ö†Ô∏è  Found potentially vulnerable dependency matching: $pattern"
              FOUND_SUSPICIOUS="true"
            fi
          done
          
          if [ -n "$FOUND_SUSPICIOUS" ]; then
            echo "üö® WARNING: Found potentially vulnerable Java/Kotlin dependencies"
            echo "üìã Actions to take:"
            echo "1. Check dependency versions against known CVEs"
            echo "2. Update to latest secure versions"
            echo "3. Run './gradlew dependencyUpdates' to see available updates"
          else
            echo "‚úÖ No obviously vulnerable dependency patterns detected"
          fi


      - name: Check for Java/Kotlin supply chain attack indicators
        run: |
          echo "üïµÔ∏è Checking for Java/Kotlin supply chain attack indicators..."
          
          # Check for typosquatting in popular libraries
          TYPOSQUAT_PATTERNS=(
            "springframework"  # Should be org.springframework
            "apache-commons"   # Should be org.apache.commons
            "jackson-databind" # Should be com.fasterxml.jackson
            "slf4j-api"        # Should be org.slf4j
            "logback-classic"  # Should be ch.qos.logback
          )
          
          echo "üîç Checking for typosquatting attempts..."
          for pattern in "${TYPOSQUAT_PATTERNS[@]}"; do
            if grep -r "$pattern" build.gradle.kts gradle/ 2>/dev/null | grep -v "org\.|com\.|ch\." | grep -v "^#"; then
              echo "‚ö†Ô∏è Potential typosquatting detected for: $pattern"
            fi
          done
          
          # Check for suspicious version patterns
          echo "üîç Checking for suspicious version patterns..."
          
          # Look for versions that might be malicious (e.g., very high version numbers)
          if grep -rE '[0-9]{3,}\.[0-9]+\.[0-9]+' build.gradle.kts gradle/ 2>/dev/null; then
            echo "‚ö†Ô∏è Found suspiciously high version numbers - verify these are legitimate"
          fi
          
          # Check for snapshot or beta versions in production dependencies
          echo "üîç Checking for snapshot/beta dependencies..."
          SNAPSHOT_DEPS=$(grep -rE '(SNAPSHOT|alpha|beta|rc[0-9])' build.gradle.kts gradle/ 2>/dev/null | grep -v "^#" || true)
          if [ -n "$SNAPSHOT_DEPS" ]; then
            echo "‚ö†Ô∏è Found pre-release dependencies (may be less secure):"
            echo "$SNAPSHOT_DEPS"
          fi
          
          echo "‚úÖ Java/Kotlin supply chain check completed"

      - name: Upload SARIF results to GitHub Security
        uses: github/codeql-action/upload-sarif@df409f7d9260372bd5f19e5b04e83cb3c43714ae # v3.29.8
        if: always() && hashFiles('build/reports/dependency-check-report.sarif') != ''
        with:
          sarif_file: build/reports/dependency-check-report.sarif
          category: owasp-dependency-check

      - name: Prepare reports for GitHub Pages
        if: always()
        run: |
          echo "üì¶ Preparing reports for GitHub Pages..."
          mkdir -p security-scans/${{ steps.date.outputs.date }}
          
          # Copy reports to timestamped directory
          if [ -f "build/reports/dependency-check-report.html" ]; then
            cp build/reports/dependency-check-report.html security-scans/${{ steps.date.outputs.date }}/
          fi
          if [ -f "build/reports/dependency-check-report.json" ]; then
            cp build/reports/dependency-check-report.json security-scans/${{ steps.date.outputs.date }}/
          fi
          if [ -f "build/reports/summary.txt" ]; then
            cp build/reports/summary.txt security-scans/${{ steps.date.outputs.date }}/
          fi
          
          # Create an index page
          cat > security-scans/${{ steps.date.outputs.date }}/index.html <<'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>OWASP Dependency Check - ${{ steps.date.outputs.date }}</title>
            <style>
              body { font-family: system-ui, -apple-system, sans-serif; max-width: 1200px; margin: 40px auto; padding: 20px; }
              h1 { color: #0366d6; }
              .card { border: 1px solid #e1e4e8; border-radius: 6px; padding: 20px; margin: 20px 0; }
              .button { display: inline-block; padding: 10px 20px; background: #0366d6; color: white; text-decoration: none; border-radius: 6px; margin: 5px; }
              .button:hover { background: #0256c7; }
            </style>
          </head>
          <body>
            <h1>üõ°Ô∏è OWASP Dependency Check Report</h1>
            <div class="card">
              <h2>Scan Information</h2>
              <p><strong>Date:</strong> ${{ steps.date.outputs.date }}</p>
              <p><strong>Project:</strong> Dimpact Zaakafhandelcomponent</p>
              <p><strong>Workflow Run:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">${{ github.run_id }}</a></p>
            </div>
            <div class="card">
              <h2>Available Reports</h2>
              <a href="dependency-check-report.html" class="button">üìÑ View HTML Report</a>
              <a href="dependency-check-report.json" class="button">üìä Download JSON</a>
              <a href="summary.txt" class="button">üìù View Summary</a>
              <a href="${{ github.server_url }}/${{ github.repository }}/security/code-scanning" class="button">üîí GitHub Security</a>
            </div>
          </body>
          </html>
          EOF

      - name: Checkout gh-pages branch to clean old reports
        if: always() && github.ref == 'refs/heads/main'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: gh-pages
          path: gh-pages-checkout

      - name: Clean up old security scan reports
        if: always() && github.ref == 'refs/heads/main'
        run: |
          echo "üßπ Cleaning up security scan reports older than ${{ env.SECURITY_SCAN_RETENTION_DAYS }} days..."
          
          cd gh-pages-checkout/security-scans 2>/dev/null || {
            echo "‚ÑπÔ∏è  No security-scans directory found yet, skipping cleanup"
            cd ..
            exit 0
          }
          
          # Calculate cutoff date (SECURITY_SCAN_RETENTION_DAYS days ago)
          if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS date command
            CUTOFF_DATE=$(date -v-${{ env.SECURITY_SCAN_RETENTION_DAYS }}d +%Y-%m-%d)
          else
            # Linux date command
            CUTOFF_DATE=$(date -d "${{ env.SECURITY_SCAN_RETENTION_DAYS }} days ago" +%Y-%m-%d)
          fi
          
          echo "üìÖ Cutoff date: $CUTOFF_DATE"
          echo "üìÇ Current security scan reports:"
          ls -la
          
          DELETED_COUNT=0
          KEPT_COUNT=0
          
          # Find and remove old report directories
          for dir in */; do
            # Remove trailing slash
            dir_name="${dir%/}"
            
            # Extract date from directory name (format: YYYY-MM-DD-HH-MM)
            # Get just the date part (YYYY-MM-DD)
            report_date=$(echo "$dir_name" | cut -d'-' -f1-3)
            
            # Skip if not a valid date format
            if [[ ! "$report_date" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              echo "‚è≠Ô∏è  Skipping '$dir_name' (not a date-based directory)"
              continue
            fi
            
            # Compare dates
            if [[ "$report_date" < "$CUTOFF_DATE" ]]; then
              echo "üóëÔ∏è  Deleting old report: $dir_name (date: $report_date)"
              rm -rf "$dir_name"
              ((DELETED_COUNT++))
            else
              echo "‚úÖ Keeping report: $dir_name (date: $report_date)"
              ((KEPT_COUNT++))
            fi
          done
          
          cd ../..
          
          echo ""
          echo "üìä Cleanup Summary:"
          echo "   - Reports deleted: $DELETED_COUNT"
          echo "   - Reports kept: $KEPT_COUNT"
          echo "   - Retention policy: ${{ env.SECURITY_SCAN_RETENTION_DAYS }} days"
          
          # Commit the deletions if any were made
          if [ $DELETED_COUNT -gt 0 ]; then
            cd gh-pages-checkout
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: remove security scan reports older than ${{ env.SECURITY_SCAN_RETENTION_DAYS }} days" || true
            git push origin gh-pages || true
            cd ..
          fi

      - name: Deploy to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./security-scans/
          destination_dir: security-scans
          keep_files: true
          enable_jekyll: false

  security-advisory-check:
    name: Check Security Advisories
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check npm security advisories
        run: |
          echo "üîç Checking for npm security advisories..."
          
          # Check main app
          if [ -f "src/main/app/package.json" ]; then
            echo "üìã Checking main app for security advisories..."
            cd src/main/app
            npm audit --audit-level=moderate || true
            cd ../..
          fi
          
          # Check e2e tests
          if [ -f "src/e2e/package.json" ]; then
            echo "üìã Checking e2e tests for security advisories..." 
            cd src/e2e
            npm audit --audit-level=moderate || true
            cd ..
          fi

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-24.04
    needs: [npm-security-audit, check-compromised-packages, gradle-security-audit, security-advisory-check]
    if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Determine overall status
        id: status
        run: |
          # Determine the overall workflow status based on job outcomes
          if [[ "${{ needs.npm-security-audit.result }}" == "failure" || 
                "${{ needs.check-compromised-packages.result }}" == "failure" || 
                "${{ needs.gradle-security-audit.result }}" == "failure" || 
                "${{ needs.security-advisory-check.result }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=:x:" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.npm-security-audit.result }}" == "success" && 
                  "${{ needs.check-compromised-packages.result }}" == "success" && 
                  "${{ needs.gradle-security-audit.result }}" == "success" && 
                  "${{ needs.security-advisory-check.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=:white_check_mark:" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "emoji=:warning:" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi


      - name: Notify Slack
        uses: 8398a7/action-slack@1750b5085f3ec60384090fb7c52965ef822e869e # v3.18.0
        with:
          status: custom
          fields: workflow,job,status
          custom_payload: |
            {
              "text": ":shield: Supply Chain Security Scan Complete",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*Status:* ${{ steps.status.outputs.status }} ${{ steps.status.outputs.emoji }}\\n*Repository:* ${{ github.repository }}\\n*Vulnerabilities:* ${{ needs.gradle-security-audit.outputs.vuln_critical || 0 }} Critical | ${{ needs.gradle-security-audit.outputs.vuln_high || 0 }} High | ${{ needs.gradle-security-audit.outputs.vuln_total || 0 }} Total"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üìÑ View Report"
                          },
                          "url": "https://infonl.github.io/dimpact-zaakafhandelcomponent/security-scans/${{ needs.gradle-security-audit.outputs.scan_date }}/"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üîí Security Tab"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/security/code-scanning"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "‚öôÔ∏è Workflow"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
