#
# SPDX-FileCopyrightText: 2025 INFO.nl
# SPDX-License-Identifier: EUPL-1.2+
#
name: Dependency Security Scan

on:
  schedule:
    # Run daily at 6 AM UTC to catch newly discovered vulnerabilities
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  security-events: write
  issues: write
  pull-requests: write
  pages: write

env:
  JAVA_VERSION: "21.0.9"
  SECURITY_SCAN_RETENTION_DAYS: 30  # Maximum age of security scan reports in days

jobs:
  npm-security-audit:
    name: NPM Security Audit
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: src/main/app/package-lock.json

      - name: Audit main app dependencies
        id: audit_main
        continue-on-error: true
        working-directory: src/main/app
        run: |
          echo "üîç Running security audit for main application..."
          npm install
          
          npm audit --json > audit-results.json || true
          
          # Convert to SARIF format
          jq -f "${{ github.workspace }}/scripts/github/helpers/npm-audit-to-sarif.jq" audit-results.json > npm-audit-main.sarif
          
          # Extract vulnerability counts from JSON
          TOTAL=$(jq '[.vulnerabilities | to_entries[] | select(.value.via | type == "array" and (map(type == "object") | any))] | length' audit-results.json)
          CRITICAL=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "critical")] | length' audit-results.json)
          HIGH=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "high")] | length' audit-results.json)
          MODERATE=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "moderate")] | length' audit-results.json)
          LOW=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "low")] | length' audit-results.json)
          
          echo "vuln_total=$TOTAL" >> $GITHUB_OUTPUT
          echo "vuln_critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "vuln_high=$HIGH" >> $GITHUB_OUTPUT
          echo "vuln_moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "vuln_low=$LOW" >> $GITHUB_OUTPUT
          
          # Display summary
          echo "üìä Vulnerability Summary:"
          echo "  Critical: $CRITICAL"
          echo "  High: $HIGH"
          echo "  Moderate: $MODERATE"
          echo "  Low: $LOW"
          echo "  Total: $TOTAL"
          
          # Fail if high or critical vulnerabilities found
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "üö® Found $CRITICAL critical and $HIGH high severity vulnerabilities!"
            exit 1
          fi

      - name: Generate npm audit summary
        if: always()
        run: |
          echo "## üì¶ NPM Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Main Application" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| üî¥ Critical | ${{ steps.audit_main.outputs.vuln_critical || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üü† High | ${{ steps.audit_main.outputs.vuln_high || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üü° Moderate | ${{ steps.audit_main.outputs.vuln_moderate || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üü¢ Low | ${{ steps.audit_main.outputs.vuln_low || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${{ steps.audit_main.outputs.vuln_total || 0 }}** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "üîí [Security Tab](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY

      - name: Upload npm audit SARIF results (main app)
        uses: github/codeql-action/upload-sarif@df409f7d9260372bd5f19e5b04e83cb3c43714ae # v3.29.8
        if: always() && hashFiles('src/main/app/npm-audit-main.sarif') != ''
        with:
          sarif_file: src/main/app/npm-audit-main.sarif
          category: npm-audit-main-app

  gradle-security-audit:
    name: Gradle Security Audit
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    outputs:
      vuln_total: ${{ steps.owasp_scan.outputs.vuln_total }}
      vuln_critical: ${{ steps.owasp_scan.outputs.vuln_critical }}
      vuln_high: ${{ steps.owasp_scan.outputs.vuln_high }}
      scan_date: ${{ steps.date.outputs.date }}
    env:
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
    steps:
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d-%H-%M')" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Setup JDK
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@017a9effdb900e5b5b2fddfb590a105619dca3c3 # v4.4.2

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@017a9effdb900e5b5b2fddfb590a105619dca3c3 # v4.4.2

      - name: Update OWASP dependency database
        run: |
          echo "üîÑ Updating OWASP Dependency Check database..."
          ./gradlew dependencyCheckUpdate --no-configuration-cache || true
          
          # Show cache info
          if [ -d ~/.gradle/dependency-check-data ]; then
            echo "üìä OWASP database cache status:"
            du -sh ~/.gradle/dependency-check-data
            ls -la ~/.gradle/dependency-check-data/*/odc.mv.db 2>/dev/null | head -3 || true
          fi

      - name: Check for vulnerable Gradle dependencies
        id: owasp_scan
        continue-on-error: true
        run: |
          # Run OWASP dependency check (now available)
          echo "üõ°Ô∏è Running OWASP Dependency Check..."
          ./gradlew dependencyCheckAnalyze --no-configuration-cache --info 2>&1 | tee owasp-scan.log || true
          
          # Show SARIF file info if generated
          if [ -f "build/reports/dependency-check-report.sarif" ]; then
            echo "‚úÖ SARIF report generated for GitHub Security upload"
            wc -l build/reports/dependency-check-report.sarif
          else
            echo "‚ùå SARIF report not found"
          fi
          
          # Save vulnerability counts for Slack notification
          if [ -f "build/reports/dependency-check-report.json" ]; then
            TOTAL_VULNS=$(jq '[.dependencies[].vulnerabilities] | flatten | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            CRITICAL_VULNS=$(jq '[.dependencies[].vulnerabilities[] | select(.severity=="CRITICAL")] | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            HIGH_VULNS=$(jq '[.dependencies[].vulnerabilities[] | select(.severity=="HIGH")] | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            echo "vuln_total=$TOTAL_VULNS" >> $GITHUB_OUTPUT
            echo "vuln_critical=$CRITICAL_VULNS" >> $GITHUB_OUTPUT
            echo "vuln_high=$HIGH_VULNS" >> $GITHUB_OUTPUT
          fi
      - name: Generate vulnerability summary
        if: always()
        run: |
          echo "üìä Generating vulnerability summary..."
          
          # Parse OWASP scan results
          TOTAL_VULNS=0
          CRITICAL_VULNS=0
          HIGH_VULNS=0
          MEDIUM_VULNS=0
          LOW_VULNS=0
          
          if [ -f "build/reports/dependency-check-report.json" ]; then
            # Extract vulnerability counts from JSON report
            TOTAL_VULNS=$(jq '[.dependencies[].vulnerabilities] | flatten | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            CRITICAL_VULNS=$(jq '[.dependencies[].vulnerabilities[] | select(.severity=="CRITICAL")] | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            HIGH_VULNS=$(jq '[.dependencies[].vulnerabilities[] | select(.severity=="HIGH")] | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            MEDIUM_VULNS=$(jq '[.dependencies[].vulnerabilities[] | select(.severity=="MEDIUM")] | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
            LOW_VULNS=$(jq '[.dependencies[].vulnerabilities[] | select(.severity=="LOW")] | length' build/reports/dependency-check-report.json 2>/dev/null || echo "0")
          fi
          
          # Write summary to GitHub Step Summary
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## üõ°Ô∏è OWASP Dependency Check Results
          
          ### Vulnerability Summary
          
          | Severity | Count |
          |----------|-------|
          | üî¥ Critical | $CRITICAL_VULNS |
          | üü† High | $HIGH_VULNS |
          | üü° Medium | $MEDIUM_VULNS |
          | üü¢ Low | $LOW_VULNS |
          | **Total** | **$TOTAL_VULNS** |
          
          üìä [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          üîí [Security Tab](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)
          
          EOF

      - name: Upload SARIF results to GitHub Security
        uses: github/codeql-action/upload-sarif@df409f7d9260372bd5f19e5b04e83cb3c43714ae # v3.29.8
        if: always() && hashFiles('build/reports/dependency-check-report.sarif') != ''
        with:
          sarif_file: build/reports/dependency-check-report.sarif
          category: owasp-dependency-check

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-24.04
    needs: [npm-security-audit, gradle-security-audit]
    if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Determine status
        id: status
        run: |
          # Determine overall status based on job results
          NPM_STATUS="${{ needs.npm-security-audit.result }}"
          GRADLE_STATUS="${{ needs.gradle-security-audit.result }}"
          
          if [[ "$NPM_STATUS" == "failure" || "$GRADLE_STATUS" == "failure" ]]; then
            echo "status=Failed" >> $GITHUB_OUTPUT
            echo "emoji=‚ùå" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          elif [[ "$NPM_STATUS" == "success" && "$GRADLE_STATUS" == "success" ]]; then
            echo "status=Passed" >> $GITHUB_OUTPUT
            echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=Completed with warnings" >> $GITHUB_OUTPUT
            echo "emoji=‚ö†Ô∏è" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack
        uses: 8398a7/action-slack@1750b5085f3ec60384090fb7c52965ef822e869e # v3.18.0
        with:
          status: custom
          fields: workflow,job,status
          custom_payload: |
            {
              "text": ":shield: Supply Chain Security Scan Complete",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*Status:* ${{ steps.status.outputs.status }} ${{ steps.status.outputs.emoji }}\\n*Repository:* ${{ github.repository }}\\n*Vulnerabilities:* ${{ needs.gradle-security-audit.outputs.vuln_critical || 0 }} Critical | ${{ needs.gradle-security-audit.outputs.vuln_high || 0 }} High | ${{ needs.gradle-security-audit.outputs.vuln_total || 0 }} Total"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üìÑ View Report"
                          },
                          "url": "https://infonl.github.io/dimpact-zaakafhandelcomponent/security-scans/${{ needs.gradle-security-audit.outputs.scan_date }}/"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üîí Security Tab"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/security/code-scanning"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "‚öôÔ∏è Workflow"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
